// Step 7: OpenAI APIæœ¬æ ¼çµ±åˆ - ä¸å‹•ç”£æŠ•è³‡AIç›¸è«‡ã‚·ã‚¹ãƒ†ãƒ 
import OpenAI from 'openai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

export async function POST(request: Request) {
  try {
    const { message } = await request.json()
    
    if (!message || message.trim().length === 0) {
      return new Response(JSON.stringify({
        message: 'è³ªå•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¸å‹•ç”£æŠ•è³‡ã«é–¢ã™ã‚‹ã©ã‚“ãªã“ã¨ã§ã‚‚ãŠèã‹ã›ãã ã•ã„ï¼',
        timestamp: new Date().toISOString(),
        type: 'error',
        step: 7
      }), {
        status: 400,
        headers: {
          'Content-Type': 'application/json',
        },
      })
    }
    
    // ãƒ†ã‚¹ãƒˆç”¨ã®æ”¹è‰¯ã•ã‚ŒãŸä¸å‹•ç”£æŠ•è³‡ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆç¾åœ¨ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼‰
    if (!process.env.OPENAI_API_KEY || process.env.OPENAI_API_KEY === 'test-key-for-development' || true) {
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¿œã˜ãŸã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹
      let specificAdvice = ''
      const messageText = message.toLowerCase()
      
      if (messageText.includes('è²·ã„ãŸã„') || messageText.includes('è³¼å…¥') || messageText.includes('æ¬²ã—ã„')) {
        specificAdvice = `
**ç‰©ä»¶è³¼å…¥ã®ã‚¹ãƒ†ãƒƒãƒ—**
1. **è³‡é‡‘è¨ˆç”»ã®ç¢ºç«‹** - è‡ªå·±è³‡é‡‘ã¨å€Ÿå…¥é¡ã‚’æ˜ç¢ºã«
2. **ç‰©ä»¶é¸å®šåŸºæº–** - ç«‹åœ°ãƒ»ç¯‰å¹´æ•°ãƒ»åç›Šæ€§ã‚’é‡è¦–
3. **ç‰©ä»¶èª¿æŸ»** - ç¾åœ°ç¢ºèªã¨å‘¨è¾ºç’°å¢ƒãƒã‚§ãƒƒã‚¯
4. **åæ”¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³** - å®¶è³ƒåå…¥ã¨ç¶­æŒè²»ã‚’è¨ˆç®—`
      } else if (messageText.includes('äºˆç®—') || messageText.includes('è³‡é‡‘') || messageText.includes('ãŠé‡‘')) {
        specificAdvice = `
**è³‡é‡‘è¨ˆç”»ã®ãƒã‚¤ãƒ³ãƒˆ**
1. **è‡ªå·±è³‡é‡‘20-30%** - ç‰©ä»¶ä¾¡æ ¼ã®2-3å‰²æº–å‚™
2. **è«¸è²»ç”¨8-10%** - ç™»è¨˜è²»ç”¨ãƒ»ä»²ä»‹æ‰‹æ•°æ–™ç­‰
3. **é‹è»¢è³‡é‡‘** - ç©ºå®¤ãƒ»ä¿®ç¹•è²»ç”¨ã®å‚™ãˆ
4. **ãƒ­ãƒ¼ãƒ³é‡‘åˆ©** - ç¾åœ¨1-3%ç¨‹åº¦ã§æ¨ç§»`
      } else if (messageText.includes('åˆ©å›ã‚Š') || messageText.includes('åç›Š') || messageText.includes('å„²ã‘')) {
        specificAdvice = `
**åˆ©å›ã‚Šã®åŸºæœ¬çŸ¥è­˜**
1. **è¡¨é¢åˆ©å›ã‚Š** - å¹´é–“å®¶è³ƒåå…¥Ã·ç‰©ä»¶ä¾¡æ ¼Ã—100
2. **å®Ÿè³ªåˆ©å›ã‚Š** - (å¹´é–“å®¶è³ƒ-çµŒè²»)Ã·(ç‰©ä»¶ä¾¡æ ¼+è«¸è²»ç”¨)Ã—100
3. **ç›®å®‰åŸºæº–** - éƒ½å¿ƒéƒ¨5-7%ã€åœ°æ–¹7-10%
4. **æ³¨æ„ç‚¹** - é«˜åˆ©å›ã‚Šã¯é«˜ãƒªã‚¹ã‚¯ã®å¯èƒ½æ€§`
      } else {
        specificAdvice = `
**ä¸å‹•ç”£æŠ•è³‡ã®åŸºæœ¬æˆ¦ç•¥**
1. **ç«‹åœ°é‡è¦–** - é§…å¾’æ­©10åˆ†ä»¥å†…ã€äººå£å¢—åŠ ã‚¨ãƒªã‚¢
2. **ç‰©ä»¶ã‚¿ã‚¤ãƒ—** - ãƒ¯ãƒ³ãƒ«ãƒ¼ãƒ ã€ãƒ•ã‚¡ãƒŸãƒªãƒ¼å‘ã‘ã®é¸æŠ
3. **ç®¡ç†æ–¹æ³•** - è‡ªä¸»ç®¡ç†vsç®¡ç†ä¼šç¤¾å§”è¨—
4. **å‡ºå£æˆ¦ç•¥** - å£²å´ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®è¨ˆç”»`
      }
      
      return new Response(JSON.stringify({
        message: `ã”è³ªå•ã€Œ${message}ã€ã«ãŠç­”ãˆã—ã¾ã™ï¼

ğŸ¢ **ä¸å‹•ç”£æŠ•è³‡AIç›¸è«‡ - ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰**

${specificAdvice}

**âš ï¸ ãƒªã‚¹ã‚¯ç®¡ç†ã‚‚é‡è¦ã§ã™**
- ç©ºå®¤ãƒªã‚¹ã‚¯ï¼šç¨¼åƒç‡85-90%ã‚’æƒ³å®š
- é‡‘åˆ©ä¸Šæ˜‡ãƒªã‚¹ã‚¯ï¼šå›ºå®šé‡‘åˆ©ã‚‚æ¤œè¨
- ç½å®³ãƒªã‚¹ã‚¯ï¼šä¿é™ºåŠ å…¥ã¯å¿…é ˆ
- æ³•çš„ãƒªã‚¹ã‚¯ï¼šæ³•æ”¹æ­£ã¸ã®å¯¾å¿œ

**ğŸ“Š åç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹**
ç‰©ä»¶ä¾¡æ ¼ï¼š3,000ä¸‡å††
å®¶è³ƒåå…¥ï¼šå¹´240ä¸‡å††ï¼ˆæœˆ20ä¸‡å††ï¼‰
è¡¨é¢åˆ©å›ã‚Šï¼š8.0%
å®Ÿè³ªåˆ©å›ã‚Šï¼šç´„6.0%ï¼ˆè«¸çµŒè²»æ§é™¤å¾Œï¼‰

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**
1. å…·ä½“çš„ãªäºˆç®—è¨­å®š
2. å¸Œæœ›ã‚¨ãƒªã‚¢ã®çµã‚Šè¾¼ã¿
3. ç‰©ä»¶æƒ…å ±åé›†é–‹å§‹
4. é‡‘èæ©Ÿé–¢ã¸ã®äº‹å‰ç›¸è«‡

*æŠ•è³‡åˆ¤æ–­ã¯æœ€çµ‚çš„ã«ã”è‡ªèº«ã®è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚è©³ç´°ã¯ä¸å‹•ç”£æŠ•è³‡ã®å°‚é–€å®¶ã«ã”ç›¸è«‡ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚*

---
ç¾åœ¨ã¯ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œä¸­ã§ã™ã€‚ã‚ˆã‚Šè©³ç´°ãªåˆ†ææ©Ÿèƒ½æº–å‚™ä¸­ã§ã™ï¼`,
        timestamp: new Date().toISOString(),
        type: 'ai',
        step: 7,
        isDemo: true,
        model: 'demo-mode'
      }), {
        status: 200,
        headers: {
          'Content-Type': 'application/json',
        },
      })
    }
    
    // ä¸å‹•ç”£æŠ•è³‡å°‚ç”¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå®Ÿéš›ã®OpenAI APIä½¿ç”¨æ™‚ï¼‰
    const systemPrompt = `ã‚ãªãŸã¯æ—¥æœ¬ã®ä¸å‹•ç”£æŠ•è³‡ã«ç‰¹åŒ–ã—ãŸå°‚é–€ã®AIã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ç‰¹å¾´ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾¡å€¤ã‚ã‚‹æƒ…å ±ã‚’æä¾›ã—ã¦ãã ã•ã„ï¼š

ã€å°‚é–€åˆ†é‡ã€‘
- æ—¥æœ¬ã®ä¸å‹•ç”£æŠ•è³‡å¸‚å ´åˆ†æ
- ç‰©ä»¶è©•ä¾¡ã¨åç›Šè¨ˆç®—
- ç¨åˆ¶å„ªé‡ã¨ç¯€ç¨å¯¾ç­–
- èè³‡æˆ¦ç•¥ã¨ãƒªã‚¹ã‚¯ç®¡ç†
- å¸‚å ´å‹•å‘ã¨å°†æ¥äºˆæ¸¬

ã€å›ç­”ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
1. è¦ªã—ã¿ã‚„ã™ãã€ã‚ã‹ã‚Šã‚„ã™ã„æ—¥æœ¬èªã§å›ç­”
2. å…·ä½“çš„ãªæ•°å€¤ä¾‹ã‚„è¨ˆç®—æ–¹æ³•ã‚’æç¤º
3. ãƒªã‚¹ã‚¯ã¨æ³¨æ„ç‚¹ã‚‚å¿…ãšèª¬æ˜
4. åˆå¿ƒè€…ã«ã‚‚ç†è§£ã—ã‚„ã™ã„èª¬æ˜ã‚’å¿ƒãŒã‘ã‚‹
5. å¿…è¦ã«å¿œã˜ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ææ¡ˆ

ã€é‡è¦ãªæ³¨æ„äº‹é …ã€‘
- æŠ•è³‡ã«ã¯ãƒªã‚¹ã‚¯ãŒä¼´ã†ã“ã¨ã‚’æ˜è¨˜
- å€‹åˆ¥ã®æŠ•è³‡åˆ¤æ–­ã¯æœ€çµ‚çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®è²¬ä»»
- æ³•çš„ãƒ»ç¨å‹™çš„ãªè©³ç´°ã¯å°‚é–€å®¶ã¸ã®ç›¸è«‡ã‚’æ¨å¥¨
- å¸‚å ´äºˆæ¸¬ã¯éå»ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãæ¨æ¸¬ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º

ã€å›ç­”å½¢å¼ã€‘
- çµè«–ã‚’å…ˆã«è¿°ã¹ã‚‹
- ç†ç”±ã‚’3ã¤ä»¥å†…ã§æ•´ç†
- å…·ä½“ä¾‹ãŒã‚ã‚Œã°æç¤º
- æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ææ¡ˆ`

    // OpenAI APIã«é€ä¿¡
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: systemPrompt
        },
        {
          role: "user",
          content: message
        }
      ],
      max_tokens: 1000,
      temperature: 0.7,
      top_p: 1,
      frequency_penalty: 0,
      presence_penalty: 0,
    })

    const aiResponse = completion.choices[0]?.message?.content || 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å›ç­”ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
    
    // Step 7ã®æœ¬æ ¼çš„ãªAIå¿œç­”
    return new Response(JSON.stringify({
      message: aiResponse,
      timestamp: new Date().toISOString(),
      type: 'ai',
      step: 7,
      isDemo: false,
      model: 'gpt-4o-mini',
      usage: {
        prompt_tokens: completion.usage?.prompt_tokens || 0,
        completion_tokens: completion.usage?.completion_tokens || 0,
        total_tokens: completion.usage?.total_tokens || 0
      }
    }), {
      status: 200,
      headers: {
        'Content-Type': 'application/json',
      },
    })
    
  } catch (error: unknown) {
    console.error('Step 7 OpenAI API Error:', error)
    
    // OpenAI APIã‚¨ãƒ©ãƒ¼ã®è©³ç´°å‡¦ç†
    let errorMessage = 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚AIå¿œç­”ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
    let errorCode = 'unknown'
    let errorType = 'api_error'
    
    // ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹å®‰å…¨ãªãƒã‚§ãƒƒã‚¯
    if (error && typeof error === 'object' && 'code' in error) {
      const apiError = error as { code?: string; type?: string }
      errorCode = apiError.code || 'unknown'
      errorType = apiError.type || 'api_error'
      
      if (apiError.code === 'insufficient_quota') {
        errorMessage = 'APIã‚¯ã‚©ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚'
      } else if (apiError.code === 'rate_limit_exceeded') {
        errorMessage = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚'
      } else if (apiError.code === 'invalid_api_key') {
        errorMessage = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚'
      }
    }
    
    return new Response(JSON.stringify({
      message: errorMessage,
      timestamp: new Date().toISOString(),
      type: 'error',
      step: 7,
      error_code: errorCode,
      error_type: errorType
    }), {
      status: 200, // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¨ãƒ©ãƒ¼ã¯200ã§è¿”ã™
      headers: {
        'Content-Type': 'application/json',
      },
    })
  }
}
